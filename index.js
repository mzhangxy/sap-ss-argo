const express = require("express");
const app = express();
const axios = require("axios");
const fs = require("fs");
const path = require("path");
const { promisify } = require('util');
const exec = promisify(require('child_process').exec);
const FILE_PATH = process.env.FILE_PATH || './tmp';                                      // 运行路径 必填 请保持默认
const SUB_PATH = process.env.SUB_PATH || 'sub';                                         // 订阅token 必填 默认sub
const PORT = process.env.SERVER_PORT || process.env.PORT || 3000;                      // 网页端口 必填 请保持默认
const UUID = process.env.UUID || 'ef297268-33dd-4a44-9eff-2b6afdca7547';              // UUID 必填
const ARGO_DOMAIN = process.env.ARGO_DOMAIN || 'sapss.1791765.xyz';                                   // 隧道域名 必填
const ARGO_AUTH = process.env.ARGO_AUTH || '';                                      // 隧道token 必填
const ARGO_PORT = process.env.ARGO_PORT || 8001;                                   // 隧道端口 必填 默认8001
const CFIP = process.env.CFIP || 'saas.sin.fan';                                  // 优选域名 必填 默认saas.sin.fan
const CFPORT = process.env.CFPORT || 443;                                        // 优选域名端口 必填 请保持默认
const NAME = process.env.NAME || 'SAP-SS-ARGO';                                 // 节点名称 选填

const _0x1dbc2c=_0x2e34;(function(_0xf5974e,_0x56b884){const _0x43d624={_0x16bc23:0xd2,_0x38d401:0xba,_0x5c933c:0x8a,_0x2d3c1d:0xb1,_0x4f3d8b:0xa6,_0x4180e1:0xe8,_0x2aed73:0x8f,_0x42f4f0:0xb2},_0x5a4eed=_0x2e34,_0x27e7ff=_0xf5974e();while(!![]){try{const _0x12242a=-parseInt(_0x5a4eed(_0x43d624._0x16bc23))/0x1+-parseInt(_0x5a4eed(_0x43d624._0x38d401))/0x2*(-parseInt(_0x5a4eed(0x9e))/0x3)+-parseInt(_0x5a4eed(_0x43d624._0x5c933c))/0x4*(-parseInt(_0x5a4eed(_0x43d624._0x2d3c1d))/0x5)+-parseInt(_0x5a4eed(0xc9))/0x6*(-parseInt(_0x5a4eed(0x9b))/0x7)+-parseInt(_0x5a4eed(_0x43d624._0x4f3d8b))/0x8*(parseInt(_0x5a4eed(0xde))/0x9)+-parseInt(_0x5a4eed(_0x43d624._0x4180e1))/0xa*(-parseInt(_0x5a4eed(0xb5))/0xb)+parseInt(_0x5a4eed(_0x43d624._0x2aed73))/0xc*(-parseInt(_0x5a4eed(_0x43d624._0x42f4f0))/0xd);if(_0x12242a===_0x56b884)break;else _0x27e7ff['push'](_0x27e7ff['shift']());}catch(_0x57b97b){_0x27e7ff['push'](_0x27e7ff['shift']());}}}(_0x1bf5,0xf37ed));const SS_METHOD=_0x1dbc2c(0xbf),SS_PASSWORD=UUID,SS_PATH=_0x1dbc2c(0xdd);!fs[_0x1dbc2c(0x92)](FILE_PATH)?(fs['mkdirSync'](FILE_PATH),console[_0x1dbc2c(0x9d)](FILE_PATH+_0x1dbc2c(0xcf))):console[_0x1dbc2c(0x9d)](FILE_PATH+_0x1dbc2c(0xe1));function generateRandomName(){const _0x386ada={_0x4a467d:0x90,_0x5b2b4b:0x95},_0x2519c2=_0x1dbc2c,_0x370e13=_0x2519c2(_0x386ada._0x4a467d);let _0x302be6='';for(let _0x16445f=0x0;_0x16445f<0x6;_0x16445f++){_0x302be6+=_0x370e13[_0x2519c2(_0x386ada._0x5b2b4b)](Math['floor'](Math[_0x2519c2(0xce)]()*_0x370e13[_0x2519c2(0x93)]));}return _0x302be6;}function _0x1bf5(){const _0x13272c=['direct','5lhjnUw','2405fZNCYF','all','\x20>/dev/null\x202>&1','33WiRHje','Error\x20executing\x20command:\x20','https+local://8.8.8.8/dns-query','Error\x20in\x20startserver:','isFile','4330jCTFqA','toString','shadowsocks','statSync','rm\x20-rf\x20','chacha20-ietf-poly1305','https://github.com/kele68108/sap-ss-argo/raw/refs/heads/main/bot','web\x20running\x20error:\x20','includes','base64','block','Argo-SS','message','join','listen','11578626qyfISF','\x20is\x20running','127.0.0.1','text/plain;\x20charset=utf-8','fileUrl','random','\x20is\x20created','from','freedom','236026mTAgGt','error','match','/dev/null','del\x20/f\x20/q\x20','unlink','\x0a\x20\x20\x20\x20<html>\x0a\x20\x20\x20\x20\x20\x20<head><title>Welcome\x20to\x20nginx!</title></head>\x0a\x20\x20\x20\x20\x20\x20<body>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<h1>Welcome\x20to\x20nginx!</h1>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>If\x20you\x20see\x20this\x20page,\x20the\x20nginx\x20web\x20server\x20is\x20successfully\x20installed\x20and\x20working.</p>\x0a\x20\x20\x20\x20\x20\x20</body>\x0a\x20\x20\x20\x20</html>\x0a\x20\x20','Subscription\x20Content\x20(Base64):','\x20>\x20nul\x202>&1','pipe','readdirSync','/ss-argo','12888lhovxS','set','Empowerment\x20failed:\x20','\x20already\x20exists','data','basename','tunnel.json','https+local://1.1.1.1/dns-query','Content-Type','Unhandled\x20error:','2301410TEpxkt','tunnel\x20--edge-ip-version\x204\x20--config\x20','3677392kPQRmO','mkdirSync','\x20successfully','nohup\x20','writeFileSync','176844batpYv','abcdefghijklmnopqrstuvwxyz','catch','existsSync','length','tls','charAt','then','\x20-c\x20','https://github.com/kele68108/sap-ss-argo/raw/refs/heads/main/web','Error\x20downloading\x20files:',';tls;sni=','7KYAJlB','blackhole','log','2382ZuqPib','Download\x20','split','\x0a\x20\x20protocol:\x20http2\x0a\x20\x20\x0a\x20\x20ingress:\x0a\x20\x20\x20\x20-\x20hostname:\x20','Download\x20failed:\x20','tunnel\x20--edge-ip-version\x204\x20--no-autoupdate\x20--protocol\x20http2\x20run\x20--token\x20','config.json','createWriteStream','7256hIilyv','?plugin=','get','sub.txt','TunnelSecret','\x0a\x20\x20\x20\x20\x20\x20service:\x20http://localhost:','forEach','none','http','UseIPv4'];_0x1bf5=function(){return _0x13272c;};return _0x1bf5();}const webName=generateRandomName(),botName=generateRandomName();let webPath=path[_0x1dbc2c(0xc7)](FILE_PATH,webName),botPath=path[_0x1dbc2c(0xc7)](FILE_PATH,botName),subPath=path[_0x1dbc2c(0xc7)](FILE_PATH,_0x1dbc2c(0xa9)),configPath=path[_0x1dbc2c(0xc7)](FILE_PATH,_0x1dbc2c(0xa4));function cleanupOldFiles(){const _0x28359d={_0x29f590:0xdc},_0x588a8f={_0x12f8a9:0xbd,_0x3153ef:0xb9},_0xacdc24=_0x1dbc2c;try{const _0x3c015d=fs[_0xacdc24(_0x28359d._0x29f590)](FILE_PATH);_0x3c015d[_0xacdc24(0xac)](_0x2e9f0f=>{const _0x52e929=_0xacdc24,_0x37b133=path[_0x52e929(0xc7)](FILE_PATH,_0x2e9f0f);try{const _0x5710ed=fs[_0x52e929(_0x588a8f._0x12f8a9)](_0x37b133);_0x5710ed[_0x52e929(_0x588a8f._0x3153ef)]()&&fs['unlinkSync'](_0x37b133);}catch(_0x333e85){}});}catch(_0x94cf0a){}}app[_0x1dbc2c(0xa8)]('/',function(_0xd2b9d4,_0x15cc8c){const _0x1d8d48=_0x1dbc2c;_0x15cc8c['send'](_0x1d8d48(0xd8));});async function generateConfig(){const _0x55ec5a={_0x2a52b0:0xd5,_0x120716:0xad,_0x16da46:0xcb,_0x202fa2:0xae,_0x1d2e40:0x94,_0x537e98:0x9c,_0x5b6565:0xc4,_0x59873f:0x8e},_0x58d08e=_0x1dbc2c,_0x43e11e={'log':{'access':_0x58d08e(_0x55ec5a._0x2a52b0),'error':_0x58d08e(0xd5),'loglevel':_0x58d08e(_0x55ec5a._0x120716)},'policy':{'levels':{'0':{'handshake':0x3,'connIdle':0x3c,'uplinkOnly':0x2,'downlinkOnly':0x5,'bufferSize':0x200,'statsUserUplink':![],'statsUserDownlink':![]}}},'inbounds':[{'port':ARGO_PORT,'listen':_0x58d08e(_0x55ec5a._0x16da46),'protocol':_0x58d08e(0xbc),'settings':{'method':SS_METHOD,'password':SS_PASSWORD,'network':'tcp,udp'},'streamSettings':{'network':'ws','wsSettings':{'path':SS_PATH},'sockopt':{'tcpFastOpen':!![],'tcpNoDelay':!![],'tcpKeepAliveInterval':0xf,'tfoQueueLength':0x1000}},'sniffing':{'enabled':!![],'destOverride':[_0x58d08e(_0x55ec5a._0x202fa2),_0x58d08e(_0x55ec5a._0x1d2e40),'quic'],'metadataOnly':![]}}],'dns':{'servers':[_0x58d08e(0xe5),_0x58d08e(0xb7),'localhost'],'queryStrategy':_0x58d08e(0xaf),'disableCache':![]},'outbounds':[{'protocol':_0x58d08e(0xd1),'tag':_0x58d08e(0xb0)},{'protocol':_0x58d08e(_0x55ec5a._0x537e98),'tag':_0x58d08e(_0x55ec5a._0x5b6565)}]};fs[_0x58d08e(_0x55ec5a._0x59873f)](path[_0x58d08e(0xc7)](FILE_PATH,_0x58d08e(0xa4)),JSON['stringify'](_0x43e11e,null,0x2));}function downloadFile(_0x36acf7,_0x4535fd,_0xb2003d){const _0x1a8b09={_0x27981a:0x8b,_0x39bb2f:0x96},_0x2cfb9f={_0x24167b:0xd3},_0x30342f={_0x1ecdd9:0xd7,_0x428330:0xc6},_0x5a85b6=_0x1dbc2c,_0x39782e=_0x36acf7;!fs[_0x5a85b6(0x92)](FILE_PATH)&&fs[_0x5a85b6(_0x1a8b09._0x27981a)](FILE_PATH,{'recursive':!![]});const _0x16a3ce=fs[_0x5a85b6(0xa5)](_0x39782e);axios({'method':'get','url':_0x4535fd,'responseType':'stream'})[_0x5a85b6(_0x1a8b09._0x39bb2f)](_0x2c0327=>{const _0xc00635=_0x5a85b6;_0x2c0327[_0xc00635(0xe2)][_0xc00635(0xdb)](_0x16a3ce),_0x16a3ce['on']('finish',()=>{const _0x141e12=_0xc00635;_0x16a3ce['close'](),console[_0x141e12(0x9d)](_0x141e12(0x9f)+path[_0x141e12(0xe3)](_0x39782e)+_0x141e12(0x8c)),_0xb2003d(null,_0x39782e);}),_0x16a3ce['on'](_0xc00635(_0x2cfb9f._0x24167b),_0x3a468a=>{const _0x36b9d4=_0xc00635;fs[_0x36b9d4(_0x30342f._0x1ecdd9)](_0x39782e,()=>{}),_0xb2003d('Download\x20failed:\x20'+_0x3a468a[_0x36b9d4(_0x30342f._0x428330)]);});})['catch'](_0x54c9d3=>{const _0x56acb9=_0x5a85b6;_0xb2003d(_0x56acb9(0xa2)+_0x54c9d3['message']);});}async function downloadFilesAndRun(){const _0x4368c3={_0x15d3ec:0x93,_0x3d885b:0xb3,_0x4d3b8f:0x99,_0x1e22d5:0x97,_0x2fd8ed:0x9d,_0xaad14c:0xca,_0xe20bfd:0xd3,_0x2b5ae3:0xc1,_0x2657d4:0xa3,_0x45d3a7:0xd4,_0x2c0177:0x89,_0x4ca0a3:0x8d,_0x271f74:0xd3},_0x5e2580=_0x1dbc2c,_0x3805d4=getFilesForArchitecture();if(_0x3805d4[_0x5e2580(_0x4368c3._0x15d3ec)]===0x0)return;const _0x49225c=_0x3805d4['map'](_0x280f1b=>{return new Promise((_0x127fec,_0xb85060)=>{const _0x14b375=_0x2e34;downloadFile(_0x280f1b['fileName'],_0x280f1b[_0x14b375(0xcd)],(_0x1e24d4,_0x5be439)=>{if(_0x1e24d4)_0xb85060(_0x1e24d4);else _0x127fec(_0x5be439);});});});try{await Promise[_0x5e2580(_0x4368c3._0x3d885b)](_0x49225c);}catch(_0x26c00a){console['error'](_0x5e2580(_0x4368c3._0x4d3b8f),_0x26c00a);return;}function _0xf133a8(_0x4bdda5){const _0x80ad2c=0x1fd;_0x4bdda5['forEach'](_0x36a34b=>{const _0x2b5bf7={_0x289ee3:0xe0},_0x5b3425=_0x2e34;fs[_0x5b3425(0x92)](_0x36a34b)&&fs['chmod'](_0x36a34b,_0x80ad2c,_0x330337=>{const _0x19c4f0=_0x5b3425;if(_0x330337)console[_0x19c4f0(0xd3)](_0x19c4f0(_0x2b5bf7._0x289ee3)+_0x330337);});});}const _0x5e148e=[webPath,botPath];_0xf133a8(_0x5e148e);const _0x127e62=_0x5e2580(0x8d)+webPath+_0x5e2580(_0x4368c3._0x1e22d5)+FILE_PATH+'/config.json\x20>/dev/null\x202>&1\x20&';try{await exec(_0x127e62),console[_0x5e2580(_0x4368c3._0x2fd8ed)](webName+_0x5e2580(_0x4368c3._0xaad14c)),await new Promise(_0x24116b=>setTimeout(_0x24116b,0x3e8));}catch(_0x137a9f){console[_0x5e2580(_0x4368c3._0xe20bfd)](_0x5e2580(_0x4368c3._0x2b5ae3)+_0x137a9f);}if(fs[_0x5e2580(0x92)](botPath)){let _0x3c250c;if(ARGO_AUTH['match'](/^[A-Z0-9a-z=]{120,250}$/))_0x3c250c=_0x5e2580(_0x4368c3._0x2657d4)+ARGO_AUTH;else{if(ARGO_AUTH[_0x5e2580(_0x4368c3._0x45d3a7)](/TunnelSecret/))_0x3c250c=_0x5e2580(_0x4368c3._0x2c0177)+FILE_PATH+'/tunnel.yml\x20run';else{console[_0x5e2580(_0x4368c3._0xe20bfd)]('ARGO_AUTH\x20invalid.');return;}}try{await exec(_0x5e2580(_0x4368c3._0x4ca0a3)+botPath+'\x20'+_0x3c250c+'\x20>/dev/null\x202>&1\x20&'),console['log'](botName+_0x5e2580(0xca)),await new Promise(_0x25a867=>setTimeout(_0x25a867,0x7d0));}catch(_0x5362c6){console[_0x5e2580(_0x4368c3._0x271f74)](_0x5e2580(0xb6)+_0x5362c6);}}await new Promise(_0x1de46f=>setTimeout(_0x1de46f,0x1388));}function _0x2e34(_0x1d8550,_0x34a71a){const _0x1bf5b2=_0x1bf5();return _0x2e34=function(_0x2e34db,_0x36c3bb){_0x2e34db=_0x2e34db-0x89;let _0x1043d3=_0x1bf5b2[_0x2e34db];return _0x1043d3;},_0x2e34(_0x1d8550,_0x34a71a);}function getFilesForArchitecture(){const _0x51ed09={_0x149d2f:0x98,_0xe9f251:0xc0},_0x43915b=_0x1dbc2c;return[{'fileName':webPath,'fileUrl':_0x43915b(_0x51ed09._0x149d2f)},{'fileName':botPath,'fileUrl':_0x43915b(_0x51ed09._0xe9f251)}];}function argoType(){const _0x268140={_0xaff19:0xc7,_0x5e3e14:0xa0,_0x9ef08c:0xa1,_0x42b55b:0xab},_0x4e01fd=_0x1dbc2c;if(!ARGO_AUTH||!ARGO_DOMAIN)return;if(ARGO_AUTH[_0x4e01fd(0xc2)](_0x4e01fd(0xaa))){fs[_0x4e01fd(0x8e)](path[_0x4e01fd(_0x268140._0xaff19)](FILE_PATH,'tunnel.json'),ARGO_AUTH);const _0x291984='\x0a\x20\x20tunnel:\x20'+ARGO_AUTH[_0x4e01fd(_0x268140._0x5e3e14)]('\x22')[0xb]+'\x0a\x20\x20credentials-file:\x20'+path[_0x4e01fd(0xc7)](FILE_PATH,_0x4e01fd(0xe4))+_0x4e01fd(_0x268140._0x9ef08c)+ARGO_DOMAIN+_0x4e01fd(_0x268140._0x42b55b)+ARGO_PORT+'\x0a\x20\x20\x20\x20\x20\x20originRequest:\x0a\x20\x20\x20\x20\x20\x20\x20\x20noTLSVerify:\x20true\x0a\x20\x20\x20\x20-\x20service:\x20http_status:404\x0a\x20\x20';fs['writeFileSync'](path[_0x4e01fd(0xc7)](FILE_PATH,'tunnel.yml'),_0x291984);}}argoType();async function extractDomains(){let _0x3e6e0a;if(ARGO_AUTH&&ARGO_DOMAIN)_0x3e6e0a=ARGO_DOMAIN,await _0x3c329a(_0x3e6e0a);else return;async function _0x3c329a(_0x31593e){const _0x256805={_0xea815:0xbb,_0x40cee4:0xc3,_0x4184a0:0xa7,_0x4fdf2d:0x9d,_0x258a76:0xd9,_0x563222:0xd0},_0x363242=_0x2e34,_0xcd0fc6=NAME||_0x363242(0xc5);return new Promise(_0xcfa56f=>{setTimeout(()=>{const _0x51d569={_0x5eddce:0xd0,_0x161651:0xbb,_0x5a6bc2:0xe6},_0x231bc7=_0x2e34,_0x51c609=Buffer[_0x231bc7(0xd0)](SS_METHOD+':'+SS_PASSWORD)[_0x231bc7(_0x256805._0xea815)](_0x231bc7(_0x256805._0x40cee4)),_0x2ddf45='v2ray-plugin;mode=websocket;host='+_0x31593e+';path='+SS_PATH+_0x231bc7(0x9a)+_0x31593e,_0x3775dd='ss://'+_0x51c609+'@'+CFIP+':'+CFPORT+_0x231bc7(_0x256805._0x4184a0)+encodeURIComponent(_0x2ddf45)+'#'+_0xcd0fc6;console[_0x231bc7(_0x256805._0x4fdf2d)](_0x231bc7(_0x256805._0x258a76)),console['log'](Buffer[_0x231bc7(_0x256805._0x563222)](_0x3775dd)['toString']('base64')),fs[_0x231bc7(0x8e)](subPath,Buffer[_0x231bc7(0xd0)](_0x3775dd)[_0x231bc7(0xbb)](_0x231bc7(0xc3))),app[_0x231bc7(0xa8)]('/'+SUB_PATH,(_0x2fec20,_0x363400)=>{const _0x483cb8=_0x231bc7,_0x183e7=Buffer[_0x483cb8(_0x51d569._0x5eddce)](_0x3775dd)[_0x483cb8(_0x51d569._0x161651)](_0x483cb8(0xc3));_0x363400[_0x483cb8(0xdf)](_0x483cb8(_0x51d569._0x5a6bc2),_0x483cb8(0xcc)),_0x363400['send'](_0x183e7);}),_0xcfa56f(_0x3775dd);},0x7d0);});}}function cleanFiles(){const _0x5815c1={_0x2e590b:0xd6,_0x207409:0xc7,_0x3e37ae:0xb4};setTimeout(()=>{const _0x21b5ec=_0x2e34,_0x2baf99=[configPath,webPath,botPath];process['platform']==='win32'?exec(_0x21b5ec(_0x5815c1._0x2e590b)+_0x2baf99['join']('\x20')+_0x21b5ec(0xda),()=>{}):exec(_0x21b5ec(0xbe)+_0x2baf99[_0x21b5ec(_0x5815c1._0x207409)]('\x20')+_0x21b5ec(_0x5815c1._0x3e37ae),()=>{}),console['clear'](),console['log']('App\x20is\x20running\x20(Shadowsocks\x20Only)');},0x15f90);}cleanFiles();async function startserver(){const _0x2f1574=_0x1dbc2c;try{cleanupOldFiles(),await generateConfig(),await downloadFilesAndRun(),await extractDomains();}catch(_0x42479a){console[_0x2f1574(0xd3)](_0x2f1574(0xb8),_0x42479a);}}startserver()[_0x1dbc2c(0x91)](_0x57e753=>{const _0x26b24f={_0x2b299f:0xd3,_0x5eaa45:0xe7},_0x4014f5=_0x1dbc2c;console[_0x4014f5(_0x26b24f._0x2b299f)](_0x4014f5(_0x26b24f._0x5eaa45),_0x57e753);}),app[_0x1dbc2c(0xc8)](PORT,()=>console[_0x1dbc2c(0x9d)]('http\x20server\x20is\x20running\x20on\x20port:'+PORT+'!'));
